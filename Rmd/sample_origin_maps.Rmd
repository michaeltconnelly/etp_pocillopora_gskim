---
title: "ETP Pocillopora sample origin maps"
author: "Mike Connelly"
date: "02/22/2022"
output: html_document
---
## Setup packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```
```{r setup packages}
library("tidyverse")
library("marmap") #for downloading and plotting bathymetry and topography data
library("raster") #for processing some spatial data
library("rnaturalearth") #for downloading shapefiles
library("rnaturalearthdata")
# library("rnaturalearthhires")
library("sf") #for processing shapefiles
library("elevatr") #for downloading elevation data
library("dplyr") #to keep things tidy
library("magrittr") #to keep things very tidy
library("ggspatial") #for scale bars and arrows
library("ggplot2") #for tidy plotting
library("ggpubr") #for easy selection of symbols
library("colourpicker") #for easy selection of colors
# visualization packages
library("scatterpie") # for plotting proportions of different lineages on map
library("ggnewscale") # for adding new fill scale to keep elevation
library("ggrepel") # for adding labels to plot
library("extrafont")
library("extrafontdb")
library("patchwork")
#
source("./R/pocillopora_etp_gksim_functions.R")
```
```{r}
theme_set(theme_bw())
```
## Sample import
```{r sample_data_import}
# samples <- read_csv("./data/pocillopora_samples.csv")
# 
all_samples <- read_csv("./data/pocillopora_samples_all_metadata.csv") # with all corrected mtorf types
stri_samples <- read_csv("./data/etp_samples.txt")
```
```{r}
samples <- filter(all_samples, all_samples$`Sample ID` %in% stri_samples$`Sample ID`)
# samples$`Region:Site` <- paste(samples$Region, samples$Site, sep = ":")
```
```{r}
unsamples <- filter(all_samples, all_samples$`Sample ID` %notin% stri_samples$`Sample ID`)
```

```{r sample_data_tidy}
# filter out irrelevant samples, select only informative columns
samples_select <- samples #%>% 
  # dplyr::filter(!is.na(`Sampling Date`)) %>% 
  # dplyr::filter(!is.na(`Latitude`)) %>% 
  # dplyr::select(`Sample ID`:`Depth (ft)`)
# count sample number across different locations
samples_locations <- samples_select %>% 
  group_by(`Region`, `Site`, `Latitude`, `Longitude`) %>% 
  count()
samples_sites <- samples_select %>% 
  group_by(`Region:Site`, `Latitude`, `Longitude`) %>% 
  count()
```

```{r}
# samples_locations$Longitude <- ifelse(samples_locations$Longitude < 0, (samples_locations$Longitude + 360), (samples_locations$Longitude)) 
# samples_locations$Study <- factor(samples_locations$Study, levels = study_levels, ordered = TRUE)
```
## Colors
```{r colors}
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}
gcolors <- gg_color_hue(n_distinct(samples_locations$Region))
# gcolors <- gg_color_hue(2)
site_colors <- c("red", "red4", "maroon", "maroon4", "darkgreen", "green4", "green", "lightgreen", "cyan", "cyan4", "turquoise", "turquoise4")
site_colors <- c("gold1", "blue", "darkblue", "steelblue", "lightblue", "darkorange3","darkorange", "orange", "orangered", "cyan", "cyan3", "cyan4", "turquoise", "lightgreen")
```

## Map of Pocillopora sample origins
### Obtain NOAA bathymetric data with marmap
```{r marmap_NOAA_bathymetric_data}
# Panama and Costa Rica - Perlas, Coiba, Coco
panama <- getNOAA.bathy(lon1 = -88, lon2 = -76,
                        lat1 = 4, lat2 = 12, resolution = 1)

# East Pacific from Revi's to Galapagos (to show Clipperton samples)
east_pacific <- getNOAA.bathy(lon1 = -112, lon2 = -76,
                        lat1 = -2, lat2 = 16, resolution = 2)

# East Pacific from Revi's to Rapa Nui
east_pacific_all <- getNOAA.bathy(lon1 = -120, lon2 = -74,
                        lat1 = -30, lat2 = 30, resolution = 3)
```
```{r marmap_NOAA_bathymetric_data_inset}
perlas <- getNOAA.bathy(lon1 = -79.5, lon2 = -78.5,
                        lat1 = 8, lat2 = 9, resolution = 1)
```

### Inspect marmap data
```{r}
summary(panama)
```
```{r}
plot(panama, image = TRUE)
scaleBathy(panama, deg = 2, x = "bottomleft", inset = 5)
```
```{r blues_test}
# Creating a custom palette of blues
blues <- c("lightsteelblue4", "lightsteelblue3",
           "lightsteelblue2", "lightsteelblue1")
# Plotting the bathymetry with different colors for land and sea
plot(panama, image = TRUE, land = TRUE, lwd = 0.1,
     bpal = list(c(0, max(panama), "grey"),
                 c(min(panama),0,blues)))
# Making the coastline more visible
plot(panama, deep = 0, shallow = 0, step = 0,
     lwd = 0.4, add = TRUE)
```
```{r etopo_test}
# Plot bathy object using custom ggplot2 functions
marmap::autoplot.bathy(panama, geom=c("r", "c"), colour="white", size=0.1) + scale_fill_etopo()
```
## Figure 1: Map of sample origins
```{r}
pdf("./outputs/figures/Fig1_samples_locations_map_bathymetry_051123.pdf", width = 8, height = 6)
title <- expression('Eastern Pacific '*italic("Pocillopora")*' genotype origins')
# Plot bathy object using custom ggplot2 functions
par(mar = c(0.5, 0.5, 0.5, 0.5))
marmap::autoplot.bathy(panama, geom=c("r", "c"), color = "white", size = 0.01) + 
  scale_fill_etopo(name = "Depth (m)") + 
  new_scale_fill() +
  geom_point(data = samples_locations,
             aes(x = `Longitude`, y = `Latitude`, size = `n`, fill = `Region`),
             shape = 21, alpha = 0.9, color = "black", stroke = 0.5,
             position = position_jitter(width = 0.2, height = 0.2, seed = 3),
             show.legend = T) +
  scale_fill_manual(values = gcolors,
                    guide = guide_legend(order = 2,
                                         override.aes = list(size = 6,
                                                             shape = 21, 
                                                             fill = gcolors),
                                         nrow = 5, title.position = "top")) +
  scale_size(range = c(1, 5), breaks = c(1, 10, 20), limits = c(0, 20),
             name = "# of samples",
             guide = guide_legend(order = 3, override.aes = list(fill = "black"),
                                  nrow = 5, title.position = "top")) +
  labs(x="Longitude", y="Latitude", elevation = "Elevation") +
  theme(panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "#f0f8ff"),
        panel.border = element_rect(fill = NA),
        plot.title = element_text(size = 16),
        axis.title = element_text(size = 14), 
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        legend.margin = margin(0,0,0,0)) +
  ggtitle(title)
dev.off()
```
```{r}
pdf("./outputs/figures/Fig1_samples_sites_map_bathymetry_051123.pdf", width = 8, height = 6)
marmap::autoplot.bathy(panama, geom=c("r", "c"), color = "white", size = 0.01) + 
  scale_fill_etopo(name = "Depth (m)") + 
  new_scale_fill() +
  geom_point(data = samples_sites,
             aes(x = `Longitude`, y = `Latitude`, size = `n`, fill = `Region:Site`),
             shape = 21, alpha = 0.9, color = "black", stroke = 0.5,
             position = position_jitter(width = 0.1, height = 0.1, seed = 3),
             show.legend = T) +
  scale_fill_manual(values = site_colors,
                    guide = guide_legend(order = 2,
                                         override.aes = list(size = 6,
                                                             shape = 21, 
                                                             fill = site_colors),
                                         nrow = 12, title.position = "top")) +
  scale_size(range = c(1, 5), breaks = c(1, 10, 20), limits = c(0, 20),
             name = "# of samples",
             guide = guide_legend(order = 3, override.aes = list(fill = "black"),
                                  nrow = 5, title.position = "top")) +
  labs(x="Longitude", y="Latitude", elevation = "Elevation") +
  theme(panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "#f0f8ff"),
        panel.border = element_rect(fill = NA),
        plot.title = element_text(size = 16),
        axis.title = element_text(size = 14), 
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        legend.margin = margin(0,0,0,0)) +
  ggtitle(title)
dev.off()
```


```{r}
# including Clipperton samples in map
pdf("../outputs/figures/Fig1_etp_samples_sites_map_bathymetry_051223.pdf", width = 8, height = 8)
title <- expression('Eastern Pacific '*italic("Pocillopora")*' sample locations (n = 122 samples total)')
marmap::autoplot.bathy(east_pacific, geom=c("r", "c"), color = "white", size = 0.01) + 
  scale_fill_etopo(name = "Depth (m)") + 
  new_scale_fill() +
  geom_point(data = samples_sites,
             aes(x = `Longitude`, y = `Latitude`, size = `n`, fill = `Region:Site`),
             shape = 21, alpha = 0.9, color = "black", stroke = 0.5,
             position = position_jitter(width = 0.1, height = 0.1, seed = 3),
             show.legend = T) +
  scale_fill_manual(values = site_colors,
                    guide = guide_legend(order = 2,
                                         override.aes = list(size = 3,
                                                             shape = 21, 
                                                             fill = site_colors),
                                         nrow = 14, title.position = "top")) +
  scale_size(range = c(1, 6), breaks = c(1, 10, 20), limits = c(0, 20),
             name = "# of samples",
             guide = guide_legend(order = 3, override.aes = list(fill = "black"),
                                  nrow = 5, title.position = "top")) +
  labs(x="Longitude", y="Latitude", elevation = "Elevation") +
  theme(panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "#f0f8ff"),
        panel.border = element_rect(fill = NA),
        plot.title = element_text(size = 14),
        axis.title = element_text(size = 10), 
        axis.text = element_text(size = 8),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 8),
        legend.margin = margin(0,0,0,0)) +
  ggtitle(title)
dev.off()
```

## Scatterpie map of *Pocillopora* mtORF types
```{r prepare_scatterpie_data}
# see example at: https://cran.r-project.org/web/packages/scatterpie/vignettes/scatterpie.html
region_coords <- samples %>% group_by(Region) %>% summarise(Longitude=mean(Longitude), Latitude=mean(Latitude))
  
regions_mtorfs <- samples %>% 
  group_by(`Region`, mtorf_type) %>% 
  dplyr::count() %>% 
  pivot_wider(names_from = mtorf_type, values_from = n, values_fill = 0) %>% 
  # dplyr::rename("Type 1" = Type_1, "Type 3" = Type_3) %>% 
  mutate("radius" = (`Type 1a` + `Type 2` + `Type 3a` + `Type 3c`)/50) %>% 
  left_join(region_coords, by = "Region")
#
sites_mtorfs <- samples %>% 
  group_by(`Region:Site`, mtorf_type) %>% 
  dplyr::count() %>% 
  pivot_wider(names_from = mtorf_type, values_from = n, values_fill = 0) %>% 
  # dplyr::rename("Type 1" = Type_1, "Type 3" = Type_3) %>% 
  mutate("radius" = (`Type 1a` + `Type 2` + `Type 3a` + `Type 3c`)/20) %>% 
  left_join(samples_sites, by = "Region:Site") %>% dplyr::select(-n)
```

### ETP w/ Clipperton
```{r regions_unscaled}
pdf("./outputs/figures/Fig1_mtorf_etp_regions_map_062123.pdf", width = 6.5, height = 3.5)
marmap::autoplot.bathy(east_pacific, geom=c("r", "c"), color = "white", size = 0.01) + 
  scale_fill_etopo(name = "Depth (m)") + 
  #
  new_scale_fill() +
  geom_scatterpie(aes(x = Longitude, y = Latitude, group = `Region`, r = 2),
                    data = regions_mtorfs, cols = c("Type 1a", "Type 2", "Type 3a", "Type 3c"), size = 5, alpha = .8) + 
  scale_fill_manual(values = c("darkorange1", "purple", "turquoise2", "turquoise4"), name = "mtORF Type") +
  labs(x="Longitude", y="Latitude") +
  theme(panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "#f0f8ff"),
        panel.border = element_rect(fill = NA),
        plot.title = element_text(size = 12),
        axis.title = element_text(size = 10), 
        axis.text = element_text(size = 8),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 8),
        legend.margin = margin(0,0,0,0)) +
  ggtitle(title)
  #
dev.off()
```
### Panama and Costa Rica
```{r regions_panama_scaled}
pdf("./outputs/figures/Fig1_mtorf_regions_map_062123.pdf", width = 6.5, height = 4.5)
title <- expression('Eastern Pacific '*italic("Pocillopora")*' mtORF types across STRI regions')
marmap::autoplot.bathy(panama, geom=c("r", "c"), color = "white", size = 0.01) + 
  scale_fill_etopo(name = "Depth (m)") + 
  #
  new_scale_fill() +
  geom_scatterpie(aes(x = Longitude, y = Latitude, group = `Region`, r = radius), 
                    data = regions_mtorfs[-1,], cols = c("Type 1a", "Type 2", "Type 3a", "Type 3c"), alpha = .8) + 
  scale_fill_manual(values = c("darkorange1", "turquoise2", "turquoise4"), name = "mtORF Type") +
  geom_scatterpie_legend(regions_mtorfs$radius, x = -80.25, y = 5.75, label_position = "right", n = 4,
                         labeller = function(x) 50*x) +
  labs(x="Longitude", y="Latitude") +
  theme(panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "#f0f8ff"),
        panel.border = element_rect(fill = NA),
        plot.title = element_text(size = 12),
        axis.title = element_text(size = 10), 
        axis.text = element_text(size = 8),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 8),
        legend.margin = margin(0,0,0,0)) +
  ggtitle(title)
  #
dev.off()
```

```{r region:sites_panama}
marmap::autoplot.bathy(panama, geom=c("r", "c"), color = "white", size = 0.01) + 
  scale_fill_etopo(name = "Depth (m)") + 
  #
  new_scale_fill() +
  geom_scatterpie(aes(x = Longitude, y = Latitude, group = `Region:Site`, r = radius),
                    data = sites_mtorfs[-1,], cols = c("Type 1a", "Type 2", "Type 3a", "Type 3c"), alpha = .8) + 
  scale_fill_manual(values = c("darkorange1", "turquoise2", "turquoise4"), name = "mtORF Type")
  #
```

I would like to find a way to plot up-close maps of Coiba, Perlas and Isla del Coco to show fine detail site variation.